<!DOCTYPE html>
<html>

<head>
    <title>🌱방명록</title>
    <!-- 스타일과 스크립트 추가가 필요하면 여기에 -->
    <link rel="stylesheet" type="text/css" href="/css/font.css">
    <link rel="stylesheet" type="text/css" href="/css/header.css">
    <link rel="stylesheet" type="text/css" href="/css/board/read.css">
    <link rel="stylesheet" type="text/css" href="/css/guestBook/add.css">

    <script>
        function toggleLikeButtons(guestBookNo) {
            const likeButton = document.getElementById('likeButton-' + guestBookNo);
            const unlikeButton = document.getElementById('unlikeButton-' + guestBookNo);

            // 버튼의 표시 상태를 전환
            if (likeButton.style.display === 'none' || likeButton.style.display === '') {
                likeButton.style.display = 'inline-block';
                unlikeButton.style.display = 'none';
            } else {
                likeButton.style.display = 'none';
                unlikeButton.style.display = 'inline-block';
            }
        }

        function likeButtonClicked(buttonElement) {
            const guestBookNo = buttonElement.getAttribute("data-guestBook-no");

            fetch(`/guestBook/like?guestBookNo=${guestBookNo}`, {
                method: 'POST'
            })
                .then(response => {
                    if (response.ok) {
                        alert("좋아요가 성공적으로 처리되었습니다.");
                        toggleLikeButtons(guestBookNo); // 버튼 상태 전환 함수 호출
                    } else {
                        alert("좋아요 처리 중 오류가 발생했습니다.");
                    }
                });
        }

        function unlikeButtonClicked(buttonElement) {
            const guestBookNo = buttonElement.getAttribute("data-board-no");

            fetch(`/guestBook/unlike?guestBookNo=${guestBookNo}`, {
                method: 'POST'
            })
                .then(response => {
                    if (response.ok) {
                        alert("좋아요 취소가 성공적으로 처리되었습니다.");
                        toggleLikeButtons(guestBookNo); // 버튼 상태 전환 함수 호출
                    } else {
                        alert("좋아요 취소 처리 중 오류가 발생했습니다.");
                    }
                });
        }
    </script>

</head>

<body>

<div data-th-replace="header :: header"></div>

<!-- "누구누구의 방명록" 추가 -->
<div class="guestbook-title" style="text-align: center;">
    <span th:text="${guestBookOwnerNick} ? ${guestBookOwnerNick + '의 방명록'} : ''"></span>
</div>

<!-- 방명록 추가 폼 -->
<div class="add-guestbook-form" style="text-align: center;">
    <h1>방명록 추가</h1>
    <form method="post" action="/guestBook/add" style="display: inline-block; text-align: center;">
        <div class="form-group">
            <label for="title">제목</label>
            <input type="text" id="title" name="title" required>
        </div>
        <div class="form-group">
            <label for="content">내용</label>
            <textarea id="content" name="content" required></textarea>
        </div>
        <button type="submit">추가</button>
        <input name="memNo" data-th-value="${no}" type="hidden">
    </form>
</div>

<!-- 게시글 목록을 출력하기 위한 Thymeleaf 반복문 -->
<div data-th-each="guestBook : ${guestBookList}">

    <div class="container">
        <!-- 게시글 목록 -->
        <table class="content-table">
            <!-- 첫 번째 행: 번호, 제목, 메타 정보 -->
            <tr class="first-row">
                <td class="no-cell" style="text-align: center;">
                    <span data-th-text="'No. ' + ${guestBook.no}"></span>
                </td>
                <td class="title-meta-cell" colspan="3">
                    <div class="horizontal-layout">
                        <span data-th-text="${guestBook.title}"></span>
                        <div class="meta-info">
                            <img class="clock-icon" src="/images/clock.png">
                            <span data-th-text="${#dates.format(guestBook.createdAt, 'yyyy-MM-dd')}"></span>
                        </div>
                    </div>
                </td>
            </tr>
            <!-- 두 번째 행: 작성자, 내용, 좋아요 -->
            <tr class="second-row">
                <td class="writer-cell" style="text-align: center;">
                    <div class="profile-picture" style="display: inline-block;">
                        <img data-th-unless="${guestBook.writer.photo}" src='/images/avatar.png'>
                        <a data-th-if="${guestBook.writer.photo}"
                           data-th-href="|https://kr.object.ncloudstorage.com/bitcamp-nc7-bucket-14/sns_member/${guestBook.writer.photo}|">
                            <img class="profile-image" alt="프로필 사진"
                                 data-th-src="|http://gjoxpfbmymto19010706.cdn.ntruss.com/sns_member/${guestBook.writer.photo}?type=f&w=270&h=270&faceopt=true&ttype=jpg|">
                        </a>
                    </div>
                    <div style="margin-top: 5px;"> <!-- 이름과 프로필 사진 사이에 간격을 조절합니다. -->
                        <span data-th-text="${guestBook.writer.nick}"></span>
                    </div>
                </td>
                <td class="content-like-cell" colspan="3" style="position: relative;">
          <span data-th-if="${guestBook != null}"
                data-th-text="${guestBook.content != null ? guestBook.content : '내용입니다!'}"></span>
                    <!-- 좋아요 버튼 -->
                    <button class="like-button"
                            data-th-id="'likeButton-' + ${guestBook.no}"
                            data-th-if="${!likedGuestBooks.contains(guestBook.no)}"
                            data-th-attr="data-guestBook-no=${guestBook.no}"
                            onclick="likeButtonClicked(this)">
                        🤍
                    </button>

                    <!-- 좋아요 취소 (좋아요 눌러져있는상태) 버튼 -->
                    <button class="unlike-button"
                            data-th-id="'unlikeButton-' + ${guestBook.no}"
                            data-th-if="${likedGuestBooks.contains(guestBook.no)}"
                            data-th-attr="data-guestBook-no=${guestBook.no}"
                            onclick="unlikeButtonClicked(this)">
                        ❤️
                    </button>
                </td>
            </tr>
        </table>
        <div class="btn-container">
            <a data-th-href="@{/guestBook/delete(memNo=${guestBook.getMemNo()},no=${guestBook.no})}">
                <div style="text-align: center; margin-left:37%; margin-bottom:2%;">
                    <button>삭제</button>
                </div>
            </a>
        </div>
    </div>
</div>
<!-- 페이징 처리 부분 -->
<div id="pageLabel">
    <!-- 이전 페이지들 -->
    <a th:if="${page > 1}" th:class="${page == 1 ? 'pagination-link pagination-link-active' : 'pagination-link'}"
       data-th-href="@{${#request.getRequestURL()}(no=${param.no},page=1,pageSize=${pageSize})}"
       data-th-text="1"></a>

    <a th:if="${page > 2}" th:class="${page == 2 ? 'pagination-link pagination-link-active' : 'pagination-link'}"
       data-th-href="@{${#request.getRequestURL()}(no=${param.no},page=(${page} - 1),pageSize=${pageSize})}"
       data-th-text="2"></a>

    <!-- 현재 페이지 -->
    <a th:class="${page == page ? 'pagination-link pagination-link-active' : 'pagination-link'}"
       data-th-href="@{${#request.getRequestURL()}(no=${param.no},page=${page},pageSize=${pageSize})}"
       data-th-text="${page}"></a>

    <!-- 다음 페이지들 -->
    <a th:if="${page < (maxPage - 1)}"
       th:class="${page + 1 == page ? 'pagination-link pagination-link-active' : 'pagination-link'}"
       data-th-href="@{${#request.getRequestURL()}(no=${param.no},page=(${page} + 1),pageSize=${pageSize})}"
       data-th-text="${page + 1}"></a>

    <a th:if="${page < maxPage}"
       th:class="${maxPage == page ? 'pagination-link pagination-link-active' : 'pagination-link'}"
       data-th-href="@{${#request.getRequestURL()}(no=${param.no},page=${maxPage},pageSize=${pageSize})}"
       data-th-text="${maxPage}"></a>
</div>

<div data-th-replace="footer :: footer"></div>

</body>
</html>